{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
/* Modern Dark Theme Styles */
html, body {
    background: linear-gradient(180deg, #1a212e 0%, #162b3e 50%, #0f5060 100%);
    color: #ffffff;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    min-height: 100vh;
    margin: 0;
    padding: 0;
}

/* Override any existing backgrounds */
.container {
    background: transparent;
}

.section {
    background: transparent;
}

.modern-container {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    padding: 30px;
    margin: 20px 0;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.page-header {
    text-align: center;
    margin-bottom: 40px;
}

.page-title {
    font-size: 2.5rem;
    font-weight: 700;
    background: linear-gradient(45deg, #64b5f6, #42a5f5, #2196f3);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 10px;
}

.list-info-card {
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(15px);
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    padding: 25px;
    margin-bottom: 30px;
    display: flex;
    align-items: center;
    gap: 20px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.list-icon {
    width: 80px;
    height: 80px;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 32px;
    color: white;
    background: linear-gradient(45deg, #FF6B6B, #FF8E8E);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
}

.list-details h3 {
    font-size: 1.8rem;
    font-weight: 600;
    color: #ffffff;
    margin-bottom: 8px;
}

.list-details p {
    color: #b0bec5;
    font-size: 1rem;
    margin: 5px 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

.movies-section {
    margin-top: 30px;
}

.section-title {
    font-size: 1.3rem;
    font-weight: 600;
    color: #ffffff;
    margin-bottom: 20px;
    text-align: center;
}

.movies-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.movie-card {
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(15px);
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
}

.movie-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
    border-color: rgba(100, 181, 246, 0.3);
}

.movie-poster {
    width: 100%;
    height: auto;
    object-fit: contain;
    transition: all 0.3s ease;  
}

.movie-card:hover .movie-poster {
    transform: scale(1.05);
}

.movie-content {
    padding: 20px;
}

.movie-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: #ffffff;
    margin-bottom: 10px;
    line-height: 1.3;
}

.movie-meta {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 15px;
    font-size: 0.9rem;
    color: #b0bec5;
}

.movie-year {
    display: flex;
    align-items: center;
    gap: 5px;
}

.movie-type {
    background: rgba(76, 175, 80, 0.2);
    color: #4caf50;
    padding: 4px 12px;
    border-radius: 12px;
    font-weight: 500;
    font-size: 0.8rem;
}

.movie-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.btn-view {
    flex: 1;
    padding: 8px 16px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 8px;
    background: transparent;
    color: #b0bec5;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    font-size: 0.9rem;
}

.btn-view:hover {
    background: rgba(255, 255, 255, 0.1);
    color: #ffffff;
    border-color: rgba(255, 255, 255, 0.5);
}

.btn-remove {
    padding: 8px 16px;
    border: none;
    border-radius: 8px;
    background: linear-gradient(45deg, #f44336, #e91e63);
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    font-size: 0.9rem;
}

.btn-remove:hover {
    background: linear-gradient(45deg, #e91e63, #f44336);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(244, 67, 54, 0.4);
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #b0bec5;
}

.empty-icon {
    font-size: 4rem;
    margin-bottom: 20px;
    opacity: 0.5;
}

.empty-title {
    font-size: 1.5rem;
    margin-bottom: 10px;
    color: #ffffff;
}

.empty-text {
    font-size: 1rem;
    line-height: 1.6;
    margin-bottom: 20px;
}

.back-btn {
    background: linear-gradient(45deg, #26a69a, #00bcd4);
    color: white;
    padding: 12px 25px;
    border-radius: 25px;
    text-decoration: none;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
    margin-bottom: 30px;
}

.back-btn:hover {
    background: linear-gradient(45deg, #00bcd4, #26a69a);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(38, 166, 154, 0.4);
    color: white;
}

.movie-count-badge {
    background: rgba(76, 175, 80, 0.2);
    color: #4caf50;
    padding: 6px 16px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.9rem;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.privacy-badge {
    display: flex;
    align-items: center;
    gap: 5px;
    padding: 6px 12px;
    border-radius: 12px;
    font-size: 0.9rem;
    font-weight: 500;
}

.privacy-badge.private {
    background: rgba(244, 67, 54, 0.2);
    color: #f44336;
}

.privacy-badge.public {
    background: rgba(76, 175, 80, 0.2);
    color: #4caf50;
}

/* Remove Movie Modal Styles */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(5px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
}

.modal-content {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    padding: 30px;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    color: white;
    text-align: center;
}

.modal-header {
    margin-bottom: 20px;
}

.warning-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(45deg, #f44336, #e91e63);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 15px;
    box-shadow: 0 8px 25px rgba(244, 67, 54, 0.3);
}

.warning-icon i {
    font-size: 28px;
    color: white;
}

.modal-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: #ffffff;
    margin: 0;
}

.modal-body {
    margin-bottom: 25px;
}

.modal-body p {
    color: #b0bec5;
    font-size: 1rem;
    line-height: 1.5;
    margin: 0;
}

.modal-actions {
    display: flex;
    gap: 15px;
    justify-content: center;
}

.modal-actions .btn-cancel {
    padding: 12px 25px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 25px;
    background: transparent;
    color: #b0bec5;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
    font-size: 0.9rem;
}

.modal-actions .btn-cancel:hover {
    background: rgba(255, 255, 255, 0.1);
    color: #ffffff;
    transform: translateY(-2px);
}

.modal-actions .btn-confirm {
    padding: 12px 25px;
    border: none;
    border-radius: 25px;
    background: linear-gradient(45deg, #f44336, #e91e63);
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
}

.modal-actions .btn-confirm:hover {
    background: linear-gradient(45deg, #e91e63, #f44336);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(244, 67, 54, 0.4);
}
</style>

<div class="modern-container">
    <!-- Back Button -->
    <a href="{% url 'personal-lists' plist.user.username %}" class="back-btn">
        <i class="material-icons">arrow_back</i>
        Back to Personal Lists
    </a>

    <div class="page-header">
        <h1 class="page-title">{{ plist.name }}</h1>
    </div>

    <!-- List Info Card -->
    <div class="list-info-card">
        <div class="list-icon">
            <i class="material-icons">favorite</i>
        </div>
        <div class="list-details">
            <h3>{{ plist.name }}</h3>
            <p>
                <i class="material-icons">person</i>
                Created by {{ plist.user.username }}
            </p>
            <p>
                <i class="material-icons">date_range</i>
                Created on {{ plist.created_at|date:"F j, Y" }}
            </p>
            <div style="display: flex; gap: 15px; margin-top: 10px;">
                <span class="movie-count-badge">
                    <i class="material-icons" style="font-size: 16px;">movie</i>
                    {{ movies|length }} movie{{ movies|length|pluralize }}
                </span>
                <span class="privacy-badge {% if plist.is_private %}private{% else %}public{% endif %}">
                    <i class="material-icons" style="font-size: 16px;">
                        {% if plist.is_private %}lock{% else %}public{% endif %}
                    </i>
                    {% if plist.is_private %}Private{% else %}Public{% endif %}
                </span>
            </div>
        </div>
    </div>

    <!-- Movies Section -->
    <div class="movies-section">
        <h2 class="section-title">Movies in this List</h2>
        
        {% if movies %}
        <div class="movies-grid">
            {% for movie in movies %}
            <div class="movie-card">
                <img src="{{ movie.Poster.url }}" alt="{{ movie.Title }}" class="movie-poster">
                <div class="movie-content">
                    <div class="movie-title">{{ movie.Title }}</div>
                    <div class="movie-meta">
                        <span class="movie-year">
                            <i class="material-icons" style="font-size: 16px;">date_range</i>
                            {{ movie.Year }}
                        </span>
                        <span class="movie-type">{{ movie.Type }}</span>
                    </div>
                    <div class="movie-actions">
                        <a href="{% url 'movie-details' movie.imdbID %}" class="btn-view">
                            <i class="material-icons" style="font-size: 16px;">visibility</i>
                            View
                        </a>
                        {% if user == plist.user %}
                        <button class="btn-remove" onclick="showRemoveMovieModal('{{ plist.id }}', '{{ movie.imdbID }}', '{{ movie.Title }}', this)">
                            <i class="material-icons" style="font-size: 16px;">delete</i>
                            Remove
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">
                <i class="material-icons">local_movies</i>
            </div>
            <div class="empty-title">No movies in this list yet</div>
            <div class="empty-text">Start adding movies to see them displayed here!</div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Remove Movie Confirmation Modal -->
<div class="modal-overlay" id="removeMovieModal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="warning-icon">
                <i class="material-icons">warning</i>
            </div>
            <h2 class="modal-title">Remove Movie</h2>
        </div>
        <div class="modal-body">
            <p id="removeMovieMessage">Are you sure you want to remove this movie from the list?</p>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn-cancel" onclick="closeRemoveMovieModal()">Cancel</button>
            <button type="button" class="btn-confirm" id="confirmRemoveMovie">Remove</button>
        </div>
    </div>
</div>

<script>
// Add random icons and colors to list icon
document.addEventListener('DOMContentLoaded', function() {
    const listIcons = [
        'favorite', 'star', 'movie', 'local_movies', 'theaters', 'video_library',
        'playlist_play', 'queue_music', 'bookmark', 'bookmark_border', 'flag',
        'label', 'tag', 'category', 'folder', 'folder_special'
    ];
    
    const iconColors = [
        ['#FF6B6B', '#FF8E8E'], ['#4ECDC4', '#6EE7DF'], ['#45B7D1', '#67C9E1'],
        ['#96CEB4', '#B8E0C8'], ['#FFEAA7', '#FFF2C7'], ['#DDA0DD', '#E6B3E6'],
        ['#98D8C8', '#B8E8D8'], ['#F7DC6F', '#F9E79F'], ['#BB8FCE', '#D2B4DE'],
        ['#85C1E9', '#A7D3F0'], ['#F8C471', '#FAD7A0'], ['#82E0AA', '#A3E8C1']
    ];
    
    const listIcon = document.querySelector('.list-icon');
    const iconElement = listIcon.querySelector('i');
    
    // Use list ID to get consistent icon and color
    const listId = {{ plist.id }};
    const icon = listIcons[listId % listIcons.length];
    const colors = iconColors[listId % iconColors.length];
    
    iconElement.textContent = icon;
    listIcon.style.background = `linear-gradient(45deg, ${colors[0]}, ${colors[1]})`;
});

// Show remove movie confirmation modal
function showRemoveMovieModal(listId, imdbId, movieTitle, buttonElement) {
    // Set the message in the modal
    document.getElementById('removeMovieMessage').textContent = `Are you sure you want to remove "${movieTitle}" from this list?`;
    
    // Store the data for the confirmation
    const confirmBtn = document.getElementById('confirmRemoveMovie');
    confirmBtn.setAttribute('data-list-id', listId);
    confirmBtn.setAttribute('data-imdb-id', imdbId);
    confirmBtn.setAttribute('data-movie-title', movieTitle);
    confirmBtn.setAttribute('data-button-id', buttonElement.id || 'remove-btn-' + imdbId);
    
    // Give the button an ID if it doesn't have one
    if (!buttonElement.id) {
        buttonElement.id = 'remove-btn-' + imdbId;
    }
    
    // Open the modal
    document.getElementById('removeMovieModal').style.display = 'flex';
}

// Close remove movie modal
function closeRemoveMovieModal() {
    document.getElementById('removeMovieModal').style.display = 'none';
}

// Remove movie from list function
function removeMovieFromList(listId, imdbId, movieTitle, buttonElement) {
    // Show loading state
    buttonElement.disabled = true;
    buttonElement.innerHTML = '<i class="material-icons" style="font-size: 16px;">hourglass_empty</i> Removing...';
    
    fetch(`/account/u/lists/${listId}/remove/${imdbId}/ajax`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
        },
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Show success toast
            showToast(data.message, 'success');
            
            // Remove the movie card from the DOM with animation
            const movieCard = buttonElement.closest('.movie-card');
            if (movieCard) {
                movieCard.style.transition = 'opacity 0.5s ease-out, transform 0.5s ease-out';
                movieCard.style.opacity = '0';
                movieCard.style.transform = 'scale(0.8)';
                setTimeout(() => {
                    movieCard.remove();
                    
                    // Update movie count badge
                    updateMovieCount();
                    
                    // Check if no movies left and show empty state
                    const remainingMovies = document.querySelectorAll('.movie-card');
                    if (remainingMovies.length === 0) {
                        showEmptyState();
                    }
                }, 500);
            }
        } else {
            // Show error toast
            showToast(data.message || 'Error removing movie', 'error');
            // Reset button state
            buttonElement.disabled = false;
            buttonElement.innerHTML = '<i class="material-icons" style="font-size: 16px;">delete</i> Remove';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('An error occurred while removing the movie.', 'error');
        // Reset button state
        buttonElement.disabled = false;
        buttonElement.innerHTML = '<i class="material-icons" style="font-size: 16px;">delete</i> Remove';
    });
}

// Update movie count badge
function updateMovieCount() {
    const movieCards = document.querySelectorAll('.movie-card');
    const countBadge = document.querySelector('.movie-count-badge');
    if (countBadge) {
        const count = movieCards.length;
        countBadge.innerHTML = `<i class="material-icons" style="font-size: 16px;">movie</i> ${count} movie${count > 1 ? 's' : ''}`;
    }
}

// Show empty state when no movies left
function showEmptyState() {
    const moviesSection = document.querySelector('.movies-section');
    const moviesGrid = document.querySelector('.movies-grid');
    
    if (moviesGrid) {
        moviesGrid.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="material-icons">local_movies</i>
                </div>
                <div class="empty-title">No movies in this list yet</div>
                <div class="empty-text">Start adding movies to see them displayed here!</div>
            </div>
        `;
    }
}

// Toast notification
function showToast(message, type) {
    // Create toast element if it doesn't exist
    let toast = document.getElementById('toast');
    if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toast';
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px 20px;
            color: white;
            font-weight: 500;
            z-index: 3000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 300px;
        `;
        document.body.appendChild(toast);
    }
    
    // Add type-specific styling
    if (type === 'success') {
        toast.style.borderLeft = '4px solid #4caf50';
    } else if (type === 'error') {
        toast.style.borderLeft = '4px solid #f44336';
    }
    
    toast.textContent = message;
    toast.classList.add('show');
    toast.style.transform = 'translateX(0)';
    
    setTimeout(() => {
        toast.style.transform = 'translateX(400px)';
    }, 3000);
}

// Get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Handle remove movie confirmation
document.addEventListener('DOMContentLoaded', function() {
    // Close modal when clicking outside
    document.getElementById('removeMovieModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeRemoveMovieModal();
        }
    });
    
    document.getElementById('confirmRemoveMovie').addEventListener('click', function() {
        const listId = this.getAttribute('data-list-id');
        const imdbId = this.getAttribute('data-imdb-id');
        const movieTitle = this.getAttribute('data-movie-title');
        const buttonId = this.getAttribute('data-button-id');
        const buttonElement = document.getElementById(buttonId);
        
        // Close the modal
        closeRemoveMovieModal();
        
        // Perform the removal
        removeMovieFromList(listId, imdbId, movieTitle, buttonElement);
    });
});
</script>

{% endblock %}
