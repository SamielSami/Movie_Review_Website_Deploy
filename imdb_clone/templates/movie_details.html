{% extends 'base.html' %}
{% load static %}



{% block content %}

      <!--   Icon Section   -->
      <div class="row">

      <div class="col s12 m12">
        <div class="card horizontal">
          <div class="card-image">

          {% if our_db is True %}
            <img src="{{ movie_data.Poster.url }}">
          {% else %}
            <img src="{{ movie_data.Poster }}">
          {% endif %}
          


          </div>
          <div class="card-stacked">
            <div class="card-content">
              <span class="card-title"><b>{{ movie_data.Title }}</b></span>
              <span>{{ movie_data.Type }}</span>
              <br>
              <p>{{ movie_data.Plot }}</p>
              <br>
              <div class="divider"></div>
              <span>Year: <b>{{ movie_data.Year }}</b></span>
              <span class="right">Rated: <b>{{ movie_data.Rated }}</b></span>
              <p>Released: <b>{{ movie_data.Released }}</b></p>
              <p>Runtime: <b>{{ movie_data.Runtime }}</b></p>

            {% if our_db is True %}
              <p>Genre: {% for genre in movie_data.Genre.all %}<b><a href="{{ genre.get_absolute_url }}">{{ genre }}</a>, </b>{% endfor %}</p>
            {% else %}
              <p>Genre: <b>{{ movie_data.Genre }} </b></p>
            {% endif %}


              <p>Director: <b>{{ movie_data.Director }}</b></p>
              <p>Writer: <b>{{ movie_data.Writer }}</b></p>


            {% if our_db is True %}
              <p>Actors: {% for actor in movie_data.Actors.all %}<a href="{{ actor.get_absolute_url }}"><b>{{ actor }}</a>, </b>{% endfor %}</p>
            {% else %}
              <p>Actors: <b>{{ movie_data.Actors }}</b></p>
            {% endif %}


              <p>Language: <b>{{ movie_data.Language }}</b></p>
              <p>Country: <b>{{ movie_data.Country }}</b></p>
              <p>Awards: <b>{{ movie_data.Awards }}</b></p>
              <div class="divider"></div>
               <ul class="collection">

                  <li class="collection-item avatar">
                    <span class="title">Rated</span>
                    <p><b>{{ reviews_avg.rate__avg }}</b> by <b>{{ reviews_count }}</b> people </p>
                  </li>


              {% if our_db is True %}

              {% for movie in movie_data.Ratings.all %}

                  {% if movie.source == 'Internet Movie Database' %}
                    <li class="collection-item avatar">
                      <img src="{% static 'img/icons/imdb_icon.png' %}" alt="" class="circle">
                      <span class="title">{{ movie.source }}</span>
                      <p><b>{{ movie.rating }}</b></p>
                      </li>
                  {% elif movie.source == 'Rotten Tomatoes' %}
                    <li class="collection-item avatar">
                      <img src="{% static 'img/icons/rt_icon.png' %}" alt="" class="circle">
                      <span class="title">{{ movie.source }}</span>
                      <p><b>{{ movie.rating }}</b></p>
                    </li>
                  {% else %}
                      <li class="collection-item avatar">
                        <img src="{% static 'img/icons/meta_icon.png' %}" alt="" class="circle">
                        <span class="title">{{ movie.source }}</span>
                        <p><b>{{ movie.rating }}</b></p>
                      </li>
                  {% endif %}

              {% endfor %}

              {% else %}

                  <li class="collection-item avatar">
                    <img src="{% static 'img/icons/imdb_icon.png' %}" alt="" class="circle">
                    <span class="title">{{ movie_data.Ratings.0.Source }}</span>
                    <p><b>{{ movie_data.Ratings.0.Value }}</b></p>
                  </li>

                  <li class="collection-item avatar">
                    <img src="{% static 'img/icons/rt_icon.png' %}" alt="" class="circle">
                    <span class="title">{{ movie_data.Ratings.1.Source }}</span>
                    <p><b>{{ movie_data.Ratings.0.Value }}</b></p>
                  </li>

                  <li class="collection-item avatar">
                    <img src="{% static 'img/icons/meta_icon.png' %}" alt="" class="circle">
                    <span class="title">{{ movie_data.Ratings.2.Source }}</span>
                    <p><b>{{ movie_data.Ratings.0.Value }}</b></p>
                  </li>

            {% endif %}

                </ul>

                <div class="divider"></div>
                <p>Box Office: <b>{{ movie_data.BoxOffice }}</b></p>
                <p>imdb Votes: <b>{{ movie_data.imdbVotes }}</b></p>
                <p>imdb ID: <b>{{ movie_data.imdbID }}</b></p>
                <p>Production: <b>{{ movie_data.Production }}</b></p>

                <br>
                {% if user_has_reviewed %}
                    <button class="waves-effect waves-light btn disabled"><i class="material-icons left">star</i>Already Rated</button>
                    <a href="{% url 'delete-review' movie_data.imdbID %}" class="waves-effect waves-light btn red"><i class="material-icons left">delete</i>Delete Review</a>
                {% else %}
                    <a href="{% url 'rate-movie' movie_data.imdbID %}" class="waves-effect waves-light btn"><i class="material-icons left">star</i>Rate</a>
                
                
                {% endif %}

                {% if in_watchlist %}
                  <button class="waves-effect waves-light btn disabled">
                    <i class="material-icons left">playlist_add</i>Already in Watchlist
                  </button>
                {% else %}
                  <a href="{% url 'add-movies-to-watch' movie_data.imdbID %}" class="waves-effect waves-light btn">
                    <i class="material-icons left">playlist_add</i>Watchlist
                  </a>
                {% endif %}

                {% if is_watched %}
                  <button class="waves-effect waves-light btn disabled">
                    <i class="material-icons left">playlist_add_checked</i>Already Watched
                  </button>
                {% else %}
                  <a href="{% url 'add-movies-watched' movie_data.imdbID %}" class="waves-effect waves-light btn">
                    <i class="material-icons left">playlist_add_checked</i>Watched
                  </a>
                {% endif %}

            </div>
          </div>
        </div>
      </div>

      </div>

      <div class="reviews-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h4 style="margin: 0;">Reviews & Ratings</h4>
        <div class="review-summary" style="text-align: right;">
          {% if reviews_count > 0 %}
            <div class="rating-display" style="font-size: 1.2em; font-weight: bold; color: #ff6f00;">
              <i class="material-icons" style="vertical-align: middle;">star</i>
              {{ reviews_avg.rate__avg|floatformat:1 }}/10
            </div>
            <p style="margin: 0; color: #666; font-size: 0.9em;">Based on {{ reviews_count }} review{{ reviews_count|pluralize }}</p>
          {% else %}
            <p style="color: #666; font-style: italic;">No reviews yet</p>
          {% endif %}
        </div>
      </div>
      <div class="divider"></div>

      {% if reviews_count > 0 %}
        <div class="reviews-container" style="margin-top: 20px;">
          {% for review in reviews %}
            <div class="review-card" style="background: #fff; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-left: 4px solid #26a69a;">
              
              <!-- Review Header -->
              <div class="review-header" style="display: flex; align-items: center; margin-bottom: 15px;">
                <div class="reviewer-avatar" style="margin-right: 15px;">
                  {% if review.user.profile.picture %}
                    <img src="{{ review.user.profile.picture.url }}" alt="" class="circle" style="width: 50px; height: 50px;">
                  {% else %}
                    <img src="{% static 'img/no_avatar.jpg' %}" alt="" class="circle" style="width: 50px; height: 50px;">
                  {% endif %}
                </div>
                <div class="reviewer-info" style="flex: 1;">
                  <h6 style="margin: 0; font-weight: bold;">{{ review.user.first_name }} {{ review.user.last_name }}</h6>
                  <p style="margin: 0; color: #666; font-size: 0.9em;">@{{ review.user.username }}</p>
                  <p style="margin: 0; color: #999; font-size: 0.8em;">{{ review.date|date:"M d, Y" }}</p>
                </div>
                <div class="rating-badge" style="background: linear-gradient(45deg, #ff6f00, #ff8f00); color: white; padding: 8px 15px; border-radius: 20px; font-weight: bold; display: flex; align-items: center; gap: 5px;">
                  <i class="material-icons" style="font-size: 18px;">star</i>
                  {{ review.rate }}/10
                </div>
              </div>

              <!-- Review Content -->
              {% if review.text %}
                <div class="review-content" style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #26a69a;">
                  <p style="margin: 0; line-height: 1.6; color: #333;">{{ review.text|truncatewords:30 }}</p>
                  {% if review.text|wordcount > 30 %}
                    <a href="{% url 'user-review' review.user.username movie_data.imdbID %}" style="color: #26a69a; text-decoration: none; font-size: 0.9em;">Read full review →</a>
                  {% endif %}
                </div>
              {% endif %}

              <!-- Review Actions -->
              <div class="review-actions" style="display: flex; align-items: center; justify-content: space-between; padding-top: 15px; border-top: 1px solid #eee;">
                <div class="action-buttons" style="display: flex; gap: 15px;">
                  {% if current_user and current_user != review.user %}
                    <a href="{% url 'user-review-like' review.user.username movie_data.imdbID %}" class="action-btn like-btn" style="display: flex; align-items: center; gap: 5px; padding: 8px 12px; border-radius: 20px; background: #e8f5e8; color: #2e7d32; text-decoration: none; transition: all 0.3s;">
                      <i class="material-icons" style="font-size: 18px;">thumb_up</i>
                      <span>{{ review.likes }}</span>
                    </a>
                    <a href="{% url 'user-review-unlike' review.user.username movie_data.imdbID %}" class="action-btn dislike-btn" style="display: flex; align-items: center; gap: 5px; padding: 8px 12px; border-radius: 20px; background: #ffebee; color: #c62828; text-decoration: none; transition: all 0.3s;">
                      <i class="material-icons" style="font-size: 18px;">thumb_down</i>
                      <span>{{ review.unlikes }}</span>
                    </a>
                  {% else %}
                    <span class="stats-display" style="display: flex; align-items: center; gap: 15px; color: #666;">
                      {% if review.likes > 0 %}
                        <span style="display: flex; align-items: center; gap: 3px;">
                          <i class="material-icons" style="font-size: 16px; color: #2e7d32;">thumb_up</i>
                          {{ review.likes }}
                        </span>
                      {% endif %}
                      {% if review.unlikes > 0 %}
                        <span style="display: flex; align-items: center; gap: 3px;">
                          <i class="material-icons" style="font-size: 16px; color: #c62828;">thumb_down</i>
                          {{ review.unlikes }}
                        </span>
                      {% endif %}
                    </span>
                  {% endif %}
                  
                  <a href="{% url 'user-review' review.user.username movie_data.imdbID %}" class="comment-link" style="display: flex; align-items: center; gap: 5px; color: #666; text-decoration: none; font-size: 0.9em;">
                    <i class="material-icons" style="font-size: 18px;">comment</i>
                    <span>{{ review.comment_count }} comment{{ review.comment_count|pluralize }}</span>
                  </a>
                </div>
              </div>

              <!-- Comments Preview -->
              {% if review.comment_count > 0 %}
                <div class="comments-preview" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #f0f0f0;">
                  <h6 style="color: #666; margin-bottom: 12px; font-size: 0.9em; font-weight: 500;">
                    <i class="material-icons tiny" style="vertical-align: middle;">comment</i>
                    Recent Comments
                  </h6>
                  {% for comment in review.comments.all|slice:":2" %}
                    <div class="comment-preview" style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-bottom: 8px; position: relative;">
                      <div style="display: flex; align-items: flex-start; gap: 10px;">
                        <strong style="color: #333; font-size: 0.9em;">{{ comment.user.first_name }} {{ comment.user.last_name }}</strong>
                        <span style="color: #666; font-size: 0.8em;">@{{ comment.user.username }}</span>
                        {% if current_user == comment.user %}
                          <a href="{% url 'delete-comment' comment.id %}" style="position: absolute; top: 8px; right: 8px; color: #c62828; text-decoration: none;">
                            <i class="material-icons tiny">delete</i>
                          </a>
                        {% endif %}
                      </div>
                      <p style="margin: 5px 0 0 0; color: #555; font-size: 0.9em; line-height: 1.4;">{{ comment.body|truncatewords:15 }}</p>
                    </div>
                  {% endfor %}
                  {% if review.comment_count > 2 %}
                    <p style="margin: 10px 0 0 0; text-align: center;">
                      <a href="{% url 'user-review' review.user.username movie_data.imdbID %}" style="color: #26a69a; text-decoration: none; font-size: 0.9em;">
                        View all {{ review.comment_count }} comments →
                      </a>
                    </p>
                  {% endif %}
                </div>
              {% endif %}

              <!-- Quick Comment Form -->
              {% if current_user %}
                <div class="quick-comment" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #f0f0f0;">
                  <form method="post" action="{% url 'user-review' review.user.username movie_data.imdbID %}" style="display: flex; gap: 10px; align-items: flex-start;">
                    {% csrf_token %}
                    <div style="flex: 1;">
                      <input type="text" name="body" placeholder="Add a comment..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 20px; font-size: 0.9em;" required>
                    </div>
                    <button type="submit" class="btn-small waves-effect waves-light" style="border-radius: 20px; background: #26a69a;">
                      <i class="material-icons">send</i>
                    </button>
                  </form>
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="no-reviews" style="text-align: center; padding: 40px; color: #666;">
          <i class="material-icons" style="font-size: 48px; color: #ccc;">rate_review</i>
          <h5 style="color: #999;">No reviews yet</h5>
          <p>Be the first to share your thoughts about this movie!</p>
          {% if current_user and not user_has_reviewed %}
            <a href="{% url 'rate-movie' movie_data.imdbID %}" class="btn waves-effect waves-light" style="margin-top: 15px;">
              <i class="material-icons left">star</i>Write First Review
            </a>
          {% endif %}
        </div>
      {% endif %}


{% endblock %}
